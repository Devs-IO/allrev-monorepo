<div class="container my-4">
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-2">Carregando dados do usuário...</p>
  </div>

  <div *ngIf="error" class="alert alert-danger shadow-sm" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
    <div class="mt-2">
      <button class="btn btn-sm btn-outline-danger" (click)="goBack()">
        Voltar para Lista
      </button>
    </div>
  </div>

  <div
    *ngIf="!loading && !error && user"
    class="row animate__animated animate__fadeIn"
  >
    <div class="col-12 mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <div
            class="avatar-circle bg-primary-subtle text-primary me-3 fw-bold fs-4 d-flex align-items-center justify-content-center"
            style="width: 56px; height: 56px; border-radius: 50%"
          >
            {{ user.name?.charAt(0) | uppercase }}
          </div>
          <div>
            <h1 class="h3 mb-0 text-primary fw-bold">
              {{ user.name }}
            </h1>
            <p class="text-muted mb-0">
              <i class="fas fa-envelope me-1"></i> {{ user.email }}
            </p>
          </div>
        </div>

        <button
          *ngIf="isAdmin"
          class="btn btn-outline-warning"
          (click)="editUser()"
        >
          <i class="fas fa-pencil-alt me-2"></i> Editar Dados
        </button>
      </div>
    </div>

    <ng-container *ngIf="!isManager; else managerView">
      <div class="col-lg-8 mb-4">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-header bg-white border-bottom py-3">
            <h5 class="mb-0 text-primary">
              <i class="fas fa-id-card me-2"></i> Informações Pessoais
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="small text-muted text-uppercase fw-bold"
                  >Telefone</label
                >
                <p class="mb-0 fs-5">{{ user.phone || "Não informado" }}</p>
              </div>
              <div class="col-md-6">
                <label class="small text-muted text-uppercase fw-bold"
                  >Endereço</label
                >
                <p class="mb-0 fs-5">{{ user.address || "Não informado" }}</p>
              </div>
              <div class="col-md-6">
                <label class="small text-muted text-uppercase fw-bold"
                  >Status Global</label
                >
                <div>
                  <span
                    class="badge"
                    [ngClass]="user.isActive ? 'bg-success' : 'bg-danger'"
                  >
                    {{ user.isActive ? "Ativo" : "Bloqueado" }}
                  </span>
                </div>
              </div>
              <div class="col-md-6">
                <label class="small text-muted text-uppercase fw-bold"
                  >Data de Cadastro</label
                >
                <p class="mb-0">
                  {{ user.createdAt | date : "dd/MM/yyyy HH:mm" }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 mb-4">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-dark text-white py-3">
            <h5 class="mb-0">
              <i class="fas fa-network-wired me-2"></i> Vínculos e Acessos
              (Multi-Tenant)
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="ps-4">Empresa (Tenant)</th>
                    <th>Papel (Role)</th>
                    <th>Desde</th>
                    <th class="text-end pe-4">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let t of userTenants">
                    <td class="ps-4 fw-medium">{{ t.companyName }}</td>
                    <td>
                      <span
                        class="badge rounded-pill border"
                        [ngClass]="{
                          'bg-warning-subtle text-warning-emphasis border-warning-subtle':
                            t.role === 'MANAGER_REVIEWERS' ||
                            t.role === 'manager_reviewers',
                          'bg-info-subtle text-info-emphasis border-info-subtle':
                            t.role === 'ASSISTANT_REVIEWERS' ||
                            t.role === 'assistant_reviewers'
                        }"
                      >
                        {{ translateRole(t.role) }}
                      </span>
                    </td>
                    <td class="text-muted">
                      {{ t.linkedAt | date : "shortDate" }}
                    </td>
                    <td class="text-end pe-4">
                      <button
                        class="btn btn-sm btn-outline-danger"
                        disabled
                        title="Gestão de vínculo"
                      >
                        <i class="fas fa-unlink"></i>
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="!userTenants?.length">
                    <td colspan="4" class="text-center py-4 text-muted">
                      Nenhum vínculo ativo encontrado.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 mb-4" *ngIf="isAdmin && relatedUsers?.length">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-primary text-white py-3">
            <h5 class="mb-0">
              <i class="fas fa-users me-2"></i>
              {{
                user.role === "MANAGER_REVIEWERS"
                  ? "Assistentes Vinculados"
                  : "Gestores & Tenants"
              }}
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="ps-4" *ngIf="user.role === 'MANAGER_REVIEWERS'">
                      Nome do Assistente
                    </th>
                    <th class="ps-4" *ngIf="user.role !== 'MANAGER_REVIEWERS'">
                      Empresa (Tenant)
                    </th>
                    <th *ngIf="user.role === 'MANAGER_REVIEWERS'">Email</th>
                    <th *ngIf="user.role === 'MANAGER_REVIEWERS'">Telefone</th>
                    <th *ngIf="user.role !== 'MANAGER_REVIEWERS'">Papel</th>
                    <th>Status do Vínculo</th>
                    <th>Vinculado em</th>
                    <th class="text-end pe-4">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let related of relatedUsers"
                    [ngClass]="{
                      'table-secondary opacity-75':
                        related.isUnlinked || related.isActive === false
                    }"
                  >
                    <!-- Se é Gestor: mostrar Assistentes -->
                    <ng-container *ngIf="user.role === 'MANAGER_REVIEWERS'">
                      <td class="ps-4 fw-medium">
                        <i
                          class="fas fa-user-circle me-2"
                          [ngClass]="{
                            'text-muted':
                              related.isUnlinked || related.isActive === false,
                            'text-info':
                              !related.isUnlinked && related.isActive !== false
                          }"
                        ></i>
                        {{ related.name }}
                        <span
                          *ngIf="related.isUnlinked"
                          class="badge bg-secondary ms-2 small"
                          >Desvinculado</span
                        >
                        <span
                          *ngIf="
                            !related.isUnlinked && related.isActive === false
                          "
                          class="badge bg-warning ms-2 small"
                          >Inativo Temporário</span
                        >
                      </td>
                      <td>{{ related.email }}</td>
                      <td class="text-muted small">
                        <i class="fas fa-phone me-1"></i>
                        {{ related.phone || "-" }}
                      </td>
                    </ng-container>
                    <!-- Se é Assistente: mostrar Gestores/Tenants -->
                    <ng-container *ngIf="user.role !== 'MANAGER_REVIEWERS'">
                      <td class="ps-4 fw-medium">
                        <i class="fas fa-building me-2 text-success"></i>
                        {{ related.companyName }}
                      </td>
                      <td>
                        <span
                          class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle"
                        >
                          {{ translateRole(related.role) }}
                        </span>
                      </td>
                    </ng-container>
                    <td>
                      <span
                        *ngIf="
                          !related.isUnlinked && related.isActive !== false
                        "
                        class="badge bg-success-subtle text-success border border-success"
                      >
                        <i class="fas fa-check-circle me-1"></i>
                        Ativo
                      </span>
                      <span
                        *ngIf="
                          !related.isUnlinked && related.isActive === false
                        "
                        class="badge bg-warning-subtle text-warning border border-warning"
                      >
                        <i class="fas fa-pause-circle me-1"></i>
                        Inativo Temporário
                      </span>
                      <span
                        *ngIf="related.isUnlinked"
                        class="badge bg-secondary-subtle text-secondary border border-secondary"
                      >
                        <i class="fas fa-unlink me-1"></i>
                        Desvinculado em
                        {{ related.unlinkedAt | date : "shortDate" }}
                      </span>
                    </td>
                    <td class="text-muted small">
                      {{ related.linkedAt | date : "shortDate" }}
                    </td>
                    <td class="text-end pe-4">
                      <button
                        class="btn btn-sm btn-outline-info"
                        *ngIf="user.role === 'MANAGER_REVIEWERS'"
                        [routerLink]="['/users', related.id]"
                        title="Visualizar assistente"
                      >
                        <i class="fas fa-eye"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #managerView>
      <div class="col-12">
        <div class="row g-4">
          <div class="col-lg-4">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body text-center py-4">
                <div class="mb-3">
                  <div
                    class="avatar-circle bg-light text-primary mx-auto fs-1 d-flex align-items-center justify-content-center"
                    style="width: 80px; height: 80px; border-radius: 50%"
                  >
                    <i class="fas fa-user-tie"></i>
                  </div>
                </div>
                <h5 class="card-title text-primary mb-1">Dados de Contato</h5>
                <p class="text-muted small mb-3">Assistente da sua equipe</p>

                <ul class="list-group list-group-flush text-start">
                  <li class="list-group-item px-0 border-0">
                    <i class="fas fa-envelope text-muted me-2"></i>
                    {{ user.email }}
                  </li>
                  <li class="list-group-item px-0 border-0">
                    <i class="fas fa-phone text-muted me-2"></i>
                    {{ user.phone || "Não informado" }}
                  </li>
                  <li class="list-group-item px-0 border-0">
                    <i class="fas fa-map-marker-alt text-muted me-2"></i>
                    {{ user.address || "Não informado" }}
                  </li>
                  <li class="list-group-item px-0 border-0">
                    <i class="fas fa-sticky-note text-muted me-2"></i>
                    <span class="text-muted small">Observação:</span>
                    <p class="mb-0 small">
                      {{ user.observation || "Nenhuma" }}
                    </p>
                  </li>
                </ul>

                <div class="mt-3 alert alert-info small text-start">
                  <i class="fas fa-info-circle me-1"></i>
                  Para remover este assistente da sua equipe, utilize a opção
                  "Excluir" na listagem anterior.
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card h-100 shadow-sm border-0">
              <div
                class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0 text-primary">
                  <i class="fas fa-tasks me-2"></i> Tarefas Atribuídas
                </h5>
                <span class="badge bg-light text-dark border"
                  >{{ functionalities.length }} tarefas</span
                >
              </div>

              <div class="card-body p-0">
                <div
                  *ngIf="functionalities.length; else noTasks"
                  class="list-group list-group-flush"
                >
                  <div
                    *ngFor="let f of functionalities"
                    class="list-group-item p-3"
                  >
                    <div
                      class="d-flex justify-content-between align-items-start mb-2"
                    >
                      <div>
                        <h6 class="mb-0 fw-bold text-dark">
                          {{ f.functionalityName }}
                        </h6>
                        <small class="text-muted"
                          >Ordem: #{{ f.orderNumber || "N/A" }}</small
                        >
                      </div>
                      <span
                        class="badge rounded-pill"
                        [ngClass]="
                          f.delivered ? 'bg-success' : 'bg-warning text-dark'
                        "
                      >
                        {{ f.delivered ? "Entregue" : "Pendente" }}
                      </span>
                    </div>
                    <p class="mb-2 text-secondary small">
                      {{
                        f.functionalityDescription ||
                          f.description ||
                          "Sem descrição."
                      }}
                    </p>
                    <div class="d-flex align-items-center text-muted small">
                      <span class="me-3">
                        <i class="far fa-calendar me-1"></i> Prazo:
                        {{ f.assistantDeadline | date : "shortDate" }}
                      </span>
                      <span *ngIf="f.assistantAmount">
                        <i class="fas fa-dollar-sign me-1"></i> Valor:
                        {{ f.assistantAmount | currency : "BRL" }}
                      </span>
                    </div>
                  </div>
                </div>

                <ng-template #noTasks>
                  <div class="text-center py-5 text-muted">
                    <i class="fas fa-clipboard-check fs-1 mb-3 opacity-25"></i>
                    <p class="mb-0">
                      Nenhuma tarefa pendente para este assistente.
                    </p>
                  </div>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-template>

    <div class="col-12 mt-4 d-flex justify-content-end">
      <button class="btn btn-secondary px-4" (click)="goBack()">
        <i class="fas fa-arrow-left me-2"></i> Voltar
      </button>
    </div>
  </div>
</div>
