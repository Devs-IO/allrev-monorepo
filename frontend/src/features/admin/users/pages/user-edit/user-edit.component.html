<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-wine mb-0">
      <i class="fas fa-user-edit"></i> Editar Usuário
    </h2>

    <!-- Status do Assistente (Gestor) - Topo -->
    <div *ngIf="!isAdmin && !loading" class="d-flex align-items-center gap-2">
      <span
        class="badge"
        [ngClass]="
          userForm.get('isActive')?.value ? 'bg-success' : 'bg-warning'
        "
      >
        {{ userForm.get("isActive")?.value ? "Ativo" : "Inativo Temporário" }}
      </span>
    </div>
  </div>

  <!-- Error Alert -->
  <div *ngIf="error" class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- Success Alert -->
  <div *ngIf="false" class="alert alert-success">
    <i class="fas fa-check-circle"></i> Usuário atualizado com sucesso!
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-2">
      {{ loading ? "Carregando dados..." : "Salvando alterações..." }}
    </p>
  </div>

  <!-- Form -->
  <form
    *ngIf="!loading && userForm"
    [formGroup]="userForm"
    (ngSubmit)="onSubmit()"
    class="user-form"
  >
    <!-- Dados Pessoais -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="fas fa-user"></i> Dados Pessoais</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- ID (readonly) - HIDDEN -->
          <!--
          <div class="col-md-6 mb-3">
            <label for="id" class="form-label">
              <i class="fas fa-hashtag"></i> ID
            </label>
            <input
              id="id"
              type="text"
              class="form-control"
              [value]="user?.id"
              readonly
              disabled
            />
          </div>
          -->

          <!-- Data de Criação (readonly) -->
          <div class="col-md-6 mb-3">
            <label for="createdAt" class="form-label">
              <i class="fas fa-calendar-plus"></i> Data de Criação
            </label>
            <input
              id="createdAt"
              type="text"
              class="form-control"
              [value]="user?.createdAt | date : 'dd/MM/yyyy HH:mm'"
              readonly
              disabled
            />
          </div>

          <!-- Nome -->
          <div class="col-md-6 mb-3">
            <label for="name" class="form-label">
              <i class="fas fa-signature"></i> Nome Completo *
            </label>
            <input
              id="name"
              type="text"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('name')"
              formControlName="name"
              placeholder="Ex: João Silva Santos"
              maxlength="100"
            />
            <div *ngIf="getFieldError('name')" class="invalid-feedback">
              {{ getFieldError("name") }}
            </div>
          </div>

          <!-- Email -->
          <div class="col-md-6 mb-3">
            <label for="email" class="form-label">
              <i class="fas fa-envelope"></i> E-mail *
            </label>
            <input
              id="email"
              type="email"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('email')"
              formControlName="email"
              placeholder="joao@exemplo.com"
              maxlength="150"
              readonly
            />
            <div *ngIf="getFieldError('email')" class="invalid-feedback">
              {{ getFieldError("email") }}
            </div>
          </div>

          <!-- Telefone -->
          <div class="col-md-6 mb-3">
            <label for="phone" class="form-label">
              <i class="fas fa-phone"></i> Telefone *
            </label>
            <input
              id="phone"
              type="text"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('phone')"
              formControlName="phone"
              appPhoneMask
              inputmode="numeric"
              placeholder="(11) 99999-9999"
            />
            <div *ngIf="getFieldError('phone')" class="invalid-feedback">
              {{ getFieldError("phone") }}
            </div>
          </div>

          <!-- Status Ativo (apenas Admin) -->
          <div class="col-md-6 mb-3" *ngIf="isAdmin">
            <label class="form-label">
              <i class="fas fa-toggle-on"></i> Status do Usuário
            </label>
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                formControlName="isActive"
                id="isActive"
                [disabled]="isEditingAdminUser"
              />
              <label class="form-check-label" for="isActive">
                {{ userForm.get("isActive")?.value ? "Ativo" : "Inativo" }}
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuração do Sistema -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="fas fa-cogs"></i> Configuração do Sistema</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Perfil/Role -->
          <div class="col-md-6 mb-3">
            <label for="role" class="form-label">
              <i class="fas fa-user-tag"></i> Perfil de Acesso *
            </label>
            <select
              id="role"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('role')"
              formControlName="role"
            >
              <option value="" disabled>Selecione o perfil</option>
              <option *ngFor="let role of roleOptions" [value]="role.value">
                {{ role.label }}
              </option>
            </select>
            <div *ngIf="getFieldError('role')" class="invalid-feedback">
              {{ getFieldError("role") }}
            </div>
          </div>

          <!-- Empresa -->
          <div class="col-md-6 mb-3">
            <label for="tenantId" class="form-label">
              <i class="fas fa-building"></i> Empresa *
            </label>
            <!-- Caso 1: Admin transformando assistente em Gestor -->
            <ng-container
              *ngIf="
                isAdmin &&
                userForm.get('role')?.value === Role.MANAGER_REVIEWERS
              "
            >
              <select
                id="tenantId"
                class="form-control"
                [class.is-invalid]="isFieldInvalid('tenantId')"
                formControlName="tenantId"
              >
                <option value="" disabled>Selecione a empresa</option>
                <option
                  *ngFor="let tenant of tenantsWithoutManager"
                  [value]="tenant.id"
                >
                  {{ tenant.companyName }}
                </option>
              </select>
              <div *ngIf="getFieldError('tenantId')" class="invalid-feedback">
                {{ getFieldError("tenantId") }}
              </div>
              <small
                *ngIf="tenantsWithoutManager.length === 0"
                class="text-warning d-block mt-2"
              >
                <i class="fas fa-info-circle"></i>
                Todas as empresas já possuem gestores vinculados.
              </small>
            </ng-container>

            <!-- Caso 2: Outros cenários ou Gestor editando -->
            <ng-container
              *ngIf="
                !isAdmin ||
                userForm.get('role')?.value !== Role.MANAGER_REVIEWERS
              "
            >
              <select
                id="tenantId"
                class="form-control"
                [class.is-invalid]="isFieldInvalid('tenantId')"
                formControlName="tenantId"
                [disabled]="true"
              >
                <option [value]="user?.tenantId || user?.tenant?.id || ''">
                  {{ tenantName }}
                </option>
              </select>
              <div *ngIf="getFieldError('tenantId')" class="invalid-feedback">
                {{ getFieldError("tenantId") }}
              </div>
            </ng-container>
          </div>

          <!-- Observação (apenas para Gestor) -->
          <div class="col-md-12 mb-3" *ngIf="!isAdmin">
            <label for="observation" class="form-label">
              <i class="fas fa-sticky-note"></i> Observação do Gestor
            </label>
            <textarea
              id="observation"
              class="form-control"
              formControlName="observation"
              placeholder="Adicione observações sobre este assistente..."
              rows="3"
              maxlength="500"
            ></textarea>
            <small class="form-text text-muted">
              Máximo 500 caracteres. Esta observação é específica da sua relação
              com este assistente.
            </small>
          </div>

          <!-- Status Temporário (apenas para Gestor) -->
          <div class="col-md-12 mb-3" *ngIf="!isAdmin">
            <label class="form-label">
              <i class="fas fa-pause-circle"></i> Alterar Status (Neste Tenant)
            </label>
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                formControlName="isActive"
                id="isActiveForTenant"
              />
              <label class="form-check-label" for="isActiveForTenant">
                {{
                  userForm.get("isActive")?.value
                    ? "Ativo para este tenant"
                    : "Inativo temporário"
                }}
              </label>
            </div>
            <small class="form-text text-muted d-block mt-2">
              <i class="fas fa-info-circle"></i>
              Você pode desativar temporariamente este assistente sem excluir o
              vínculo. Ele será reativado quando você alterar o status de volta.
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="d-flex justify-content-end gap-2">
      <button
        type="button"
        class="btn btn-secondary"
        routerLink="/users"
        [disabled]="loading"
      >
        <i class="fas fa-times"></i> Cancelar
      </button>

      <button
        type="submit"
        class="btn btn-wine"
        [disabled]="!userForm.valid || loading || !hasFormChanged()"
      >
        <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
        <i class="fas fa-save" *ngIf="!loading"></i>
        {{ loading ? "Salvando..." : "Salvar Alterações" }}
      </button>
    </div>
  </form>
</div>
