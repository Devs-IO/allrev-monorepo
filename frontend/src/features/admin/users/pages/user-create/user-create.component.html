<div class="container my-4">
  <h2 class="text-wine">
    <i class="fas fa-user-plus"></i> Cadastrar Novo Usuário
  </h2>

  <!-- Error Alert -->
  <div *ngIf="error" class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- Success Alert -->
  <div *ngIf="success" class="alert alert-success">
    <i class="fas fa-check-circle"></i> Usuário criado com sucesso!
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-2">Salvando dados...</p>
  </div>

  <!-- Form -->
  <form
    *ngIf="!loading"
    [formGroup]="userForm"
    (ngSubmit)="onSubmit()"
    class="user-form"
  >
    <!-- Dados Pessoais -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="fas fa-user"></i> Dados Pessoais</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Nome -->
          <div class="col-md-6 mb-3">
            <label for="name" class="form-label">
              <i class="fas fa-signature"></i> Nome Completo *
            </label>
            <input
              id="name"
              type="text"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('name')"
              formControlName="name"
              placeholder="Ex: João Silva Santos"
              maxlength="100"
            />
            <div *ngIf="getFieldError('name')" class="invalid-feedback">
              {{ getFieldError("name") }}
            </div>
          </div>

          <!-- Email -->
          <div class="col-md-6 mb-3">
            <label for="email" class="form-label">
              <i class="fas fa-envelope"></i> E-mail *
            </label>
            <input
              id="email"
              type="email"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('email')"
              formControlName="email"
              placeholder="joao@exemplo.com"
              maxlength="150"
            />
            <div *ngIf="getFieldError('email')" class="invalid-feedback">
              {{ getFieldError("email") }}
            </div>
          </div>

          <!-- Telefone -->
          <div class="col-md-6 mb-3">
            <label for="phone" class="form-label">
              <i class="fas fa-phone"></i> Telefone *
            </label>
            <input
              id="phone"
              type="text"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('phone')"
              formControlName="phone"
              appPhoneMask
              inputmode="numeric"
              placeholder="(11) 99999-9999"
            />
            <div *ngIf="getFieldError('phone')" class="invalid-feedback">
              {{ getFieldError("phone") }}
            </div>
          </div>

          <!-- Status Ativo -->
          <div class="col-md-6 mb-3">
            <label class="form-label">
              <i class="fas fa-toggle-on"></i> Status do Usuário
            </label>
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                formControlName="isActive"
                id="isActive"
              />
              <label class="form-check-label" for="isActive">
                {{ userForm.get("isActive")?.value ? "Ativo" : "Inativo" }}
              </label>
            </div>
          </div>

          <!-- Endereço -->
          <div class="col-12 mb-3">
            <label for="address" class="form-label">
              <i class="fas fa-map-marker-alt"></i> Endereço *
            </label>
            <input
              id="address"
              type="text"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('address')"
              formControlName="address"
              placeholder="Digite o endereço completo"
            />
            <div *ngIf="getFieldError('address')" class="invalid-feedback">
              {{ getFieldError("address") }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuração do Sistema -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="fas fa-cogs"></i> Configuração do Sistema</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Perfil/Role -->
          <div class="col-md-6 mb-3">
            <label for="role" class="form-label">
              <i class="fas fa-user-tag"></i> Perfil de Acesso *
            </label>
            <select
              id="role"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('role')"
              formControlName="role"
            >
              <option value="" disabled>Selecione o perfil</option>
              <option *ngFor="let role of roleOptions" [value]="role.value">
                {{ role.label }}
              </option>
            </select>
            <div *ngIf="getFieldError('role')" class="invalid-feedback">
              {{ getFieldError("role") }}
            </div>
          </div>

          <!-- Empresa -->
          <div class="col-md-6 mb-3">
            <label for="tenantId" class="form-label">
              <i class="fas fa-building"></i> Empresa *
            </label>

            <!-- Para Administradores: Select com lista de tenants -->
            <select
              *ngIf="isAdmin"
              id="tenantId"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('tenantId')"
              formControlName="tenantId"
            >
              <option value="" disabled>Selecione a empresa</option>
              <option *ngFor="let tenant of tenants" [value]="tenant.id">
                {{ tenant.companyName }}
              </option>
            </select>

            <!-- Para Gerentes: Input readonly com tenant fixo -->
            <input
              *ngIf="!isAdmin"
              type="text"
              id="tenantId"
              class="form-control"
              [value]="tenantName || 'Nenhuma empresa associada'"
              readonly
              disabled
              placeholder="Empresa do usuário logado"
            />
            <small *ngIf="!isAdmin" class="form-text text-muted">
              Usuários não-administradores são criados apenas na empresa do
              usuário logado
            </small>

            <div *ngIf="getFieldError('tenantId')" class="invalid-feedback">
              {{ getFieldError("tenantId") }}
            </div>
          </div>
        </div>

        <!-- Senha removida: backend gera automaticamente uma senha temporária e envia por e-mail -->
      </div>
    </div>

    <!-- Form Actions -->
    <div class="d-flex justify-content-end gap-2">
      <button
        type="button"
        class="btn btn-secondary"
        routerLink="/users"
        [disabled]="loading"
      >
        <i class="fas fa-times"></i> Cancelar
      </button>

      <button
        type="submit"
        class="btn btn-wine"
        [disabled]="!userForm.valid || loading"
      >
        <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
        <i class="fas fa-save" *ngIf="!loading"></i>
        {{ loading ? "Salvando..." : "Cadastrar Usuário" }}
      </button>
    </div>
  </form>
</div>
