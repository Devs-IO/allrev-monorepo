<div class="container-fluid p-3 p-md-4" style="max-width: 1200px">
  <form [formGroup]="orderForm" (ngSubmit)="onSubmit()">
    <div
      class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3"
    >
      <div>
        <h4 class="mb-1 fw-bold text-brand">
          <i class="fas fa-file-invoice me-2"></i>Nova Ordem de Serviço
        </h4>
        <p class="text-muted small mb-0">
          Cadastre o cliente, defina os serviços e gere as parcelas
        </p>
      </div>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-light border" routerLink="/orders">
          Cancelar
        </button>
        <button
          type="submit"
          class="btn btn-primary bg-brand border-0"
          [disabled]="submitting"
          style="background-color: #57040f"
        >
          <i
            *ngIf="submitting"
            class="spinner-border spinner-border-sm me-1"
          ></i>
          <i *ngIf="!submitting" class="bi bi-check2-circle me-1"></i>
          Salvar Ordem
        </button>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-12 col-xl-6">
        <div class="card mb-4">
          <div class="card-header">
            <h5><i class="bi bi-person-lines-fill me-2"></i>Dados Iniciais</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-8">
                <label class="form-label">Cliente *</label>
                <div class="input-group">
                  <span class="input-group-text bg-white border-end-0"
                    ><i class="bi bi-search text-muted"></i
                  ></span>
                  <select
                    class="form-select border-start-0 ps-0"
                    formControlName="clientId"
                    [class.is-invalid]="isInvalid(orderForm.get('clientId'))"
                  >
                    <option [ngValue]="null" disabled>
                      Selecione um cliente...
                    </option>
                    <option *ngFor="let client of clients" [value]="client.id">
                      {{ client.name }}
                    </option>
                  </select>
                </div>
                <div
                  class="invalid-feedback d-block"
                  *ngIf="isInvalid(orderForm.get('clientId'))"
                >
                  Obrigatório
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Data do Contrato *</label>
                <input
                  type="date"
                  class="form-control"
                  formControlName="contractDate"
                />
              </div>

              <div class="col-12">
                <label class="form-label">Descrição / Identificação *</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="description"
                  placeholder="Ex: TCC Engenharia Civil - Matheus"
                />
              </div>

              <div class="col-12">
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="hasInvoice"
                    formControlName="hasInvoice"
                  />
                  <label class="form-check-label" for="hasInvoice">
                    <i class="bi bi-receipt me-1"></i>
                    <strong>Nota Fiscal?</strong>
                    <span class="small text-muted ms-2">
                      Marque se a ordem possui nota fiscal
                    </span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="text-brand m-0 fw-bold fs-6">
            <i class="bi bi-list-check me-2"></i>Serviços Contratados
          </h5>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary"
            (click)="addItem()"
          >
            <i class="bi bi-plus-lg me-1"></i> Adicionar Outro Item
          </button>
        </div>

        <div formArrayName="items">
          <div
            *ngFor="let item of items.controls; let i = index"
            [formGroupName]="i"
            class="item-card"
          >
            <div class="item-index">{{ i + 1 }}</div>

            <button
              *ngIf="items.length > 1"
              type="button"
              class="btn btn-sm btn-remove"
              (click)="removeItem(i)"
              title="Remover item"
            >
              <i class="bi bi-trash"></i>
            </button>

            <div class="row g-3">
              <div class="col-12 col-lg-8">
                <label class="form-label fw-semibold"
                  >Funcionalidade / Serviço</label
                >
                <select
                  class="form-select form-select-lg"
                  formControlName="functionalityId"
                  (change)="onServiceSelected(i, $any($event.target).value)"
                >
                  <option value="" disabled>Selecione...</option>
                  <option
                    *ngFor="let func of functionalities"
                    [value]="func.id"
                    [hidden]="!!func.deletedAt"
                    [disabled]="!!func.inactiveReason"
                    [attr.title]="
                      func.inactiveReason
                        ? getInactiveReasonText(func.inactiveReason)
                        : ''
                    "
                  >
                    {{ func.name }}
                    <span *ngIf="func.inactiveReason" class="text-muted">
                      [INATIVO]</span
                    >
                  </option>
                </select>
              </div>

              <div class="col-12 col-lg-4">
                <label class="form-label fw-semibold">Responsável (Auto)</label>
                <input
                  type="text"
                  class="form-control bg-light"
                  formControlName="responsibleName"
                  readonly
                  tabindex="-1"
                />
              </div>

              <div class="col-6 col-md-3">
                <label class="form-label text-brand">Prazo Cliente</label>
                <input
                  type="date"
                  class="form-control"
                  formControlName="clientDeadline"
                />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Prazo Revisor</label>
                <input
                  type="date"
                  class="form-control"
                  formControlName="assistantDeadline"
                />
              </div>

              <div class="col-6 col-md-3">
                <label class="form-label text-success fw-bold"
                  >Preço Venda (R$)</label
                >
                <div class="input-group">
                  <span class="input-group-text px-2 text-success fw-bold"
                    >R$</span
                  >
                  <input
                    type="number"
                    class="form-control fw-bold text-success"
                    formControlName="clientPrice"
                    placeholder="0.00"
                  />
                </div>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label text-danger">Custo Revisor (R$)</label>
                <div class="input-group">
                  <span class="input-group-text px-2 text-danger">R$</span>
                  <input
                    type="number"
                    class="form-control text-danger"
                    formControlName="assistantPrice"
                    placeholder="0.00"
                  />
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Observação</label>
                <textarea
                  class="form-control"
                  formControlName="description"
                  rows="3"
                  placeholder="Adicione observações sobre este serviço..."
                  maxlength="500"
                ></textarea>
                <small class="form-text text-muted">
                  Máximo 500 caracteres
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-6">
        <div
          class="card shadow-sm border-0 sticky-top"
          style="top: 1rem; z-index: 10"
        >
          <div class="card-header bg-brand-subtle">
            <h5 class="text-brand">
              <i class="bi bi-wallet2 me-2"></i>Pagamento
            </h5>
          </div>
          <div class="card-body">
            <div class="text-center py-3 mb-3 border-bottom border-dashed">
              <div class="text-muted small text-uppercase fw-bold">
                Valor Total da Ordem
              </div>
              <div class="display-6 fw-bold text-brand">
                {{ orderForm.get("totalValue")?.value | currency : "BRL" }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Quantidade de Parcelas</label>
              <select
                class="form-select form-select-lg mb-3"
                formControlName="installmentsCount"
                [disabled]="
                  !canAddInstallments() && installmentsList.length >= 5
                "
              >
                <option *ngFor="let opt of installmentsOptions" [value]="opt">
                  {{ opt }}x Parcelas
                </option>
              </select>
              <small
                *ngIf="installmentsList.length >= 5"
                class="text-danger d-block"
              >
                <i class="bi bi-exclamation-circle me-1"></i>
                Máximo de 5 parcelas permitidas
              </small>
            </div>

            <div class="table-responsive bg-white rounded border">
              <table class="table table-sm table-installments mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="text-center" style="width: 30px">#</th>
                    <th>Valor</th>
                    <th>Vencimento</th>
                    <th>Método de Pagamento</th>
                    <th>Descrição</th>
                  </tr>
                </thead>
                <tbody formArrayName="installmentsList">
                  <tr
                    *ngFor="
                      let inst of installmentsList.controls;
                      let i = index
                    "
                    [formGroupName]="i"
                  >
                    <td class="text-center text-muted fw-bold">{{ i + 1 }}</td>
                    <td>
                      <input
                        type="number"
                        class="form-control form-control-sm fw-bold text-dark"
                        formControlName="amount"
                        step="0.01"
                      />
                    </td>
                    <td>
                      <input
                        type="date"
                        class="form-control form-control-sm text-muted"
                        formControlName="dueDate"
                      />
                    </td>
                    <td>
                      <select
                        class="form-select form-select-sm"
                        formControlName="paymentMethod"
                      >
                        <option value="BOLETO">Boleto</option>
                        <option value="CREDIT_CARD">Cartão</option>
                        <option value="PIX">PIX</option>
                        <option value="OTHER">Outro</option>
                      </select>
                    </td>
                    <td>
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        formControlName="paymentMethodDescription"
                        [placeholder]="
                          inst.get('paymentMethod')?.value === 'OTHER'
                            ? 'Especifique o método'
                            : 'Observação'
                        "
                      />
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div
              class="mt-3"
              *ngIf="installmentsList.controls.length > 0"
              [formGroupName]="0"
            >
              <p class="small text-muted fst-italic mt-2">
                <i class="bi bi-info-circle me-1"></i>
                A forma de pagamento pode ser ajustada individualmente na tabela
                acima se necessário (adicionar coluna se precisar). Por padrão:
                <strong>PIX</strong> na 1ª e <strong>Boleto/Outros</strong> nas
                demais.
              </p>
            </div>
          </div>
          <div class="card-footer bg-light">
            <button
              type="submit"
              class="btn btn-primary w-100 py-2"
              [disabled]="submitting || orderForm.invalid"
              style="background-color: #57040f; border: none"
            >
              Confirmar e Gerar Ordem
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
