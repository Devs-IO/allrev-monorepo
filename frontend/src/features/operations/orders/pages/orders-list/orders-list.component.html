<div class="container-fluid p-3 p-md-4" style="max-width: 1400px">
  <div
    class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3"
  >
    <div>
      <h5 class="mb-1 fw-bold text-brand">
        <i class="fas fa-clipboard-list me-2"></i>Gestão de Ordens
      </h5>
      <p class="text-muted small mb-0">Gerencie vendas e acompanhe serviços</p>
    </div>

    <div class="d-flex gap-2">
      <div class="btn-group" role="group">
        <button
          type="button"
          class="btn btn-sm"
          [class.btn-brand]="viewMode === 'MANAGERIAL'"
          [class.btn-outline-brand]="viewMode !== 'MANAGERIAL'"
          (click)="toggleViewMode('MANAGERIAL')"
        >
          <i class="bi bi-briefcase me-1"></i> Por Cliente (Gerencial)
        </button>
        <button
          type="button"
          class="btn btn-sm"
          [class.btn-brand]="viewMode === 'OPERATIONAL'"
          [class.btn-outline-brand]="viewMode !== 'OPERATIONAL'"
          (click)="toggleViewMode('OPERATIONAL')"
        >
          <i class="bi bi-list-check me-1"></i> Por Serviço (Operacional)
        </button>
      </div>

      <button
        class="btn btn-sm btn-brand d-flex align-items-center"
        (click)="goToCreateOrder()"
      >
        <i class="bi bi-plus-lg me-1"></i> Nova Ordem
      </button>
    </div>
  </div>

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-3">
      <form [formGroup]="filterForm" class="row g-2 align-items-end">
        <div class="col-6 col-md-3 col-lg-2">
          <label class="form-label small text-muted mb-1">Cliente</label>
          <select formControlName="clientId" class="form-select form-select-sm">
            <option value="">Todos</option>
            <option *ngFor="let c of clients$ | async" [value]="c.id">
              {{ c.name }}
            </option>
          </select>
        </div>

        <div class="col-6 col-md-3 col-lg-2">
          <label class="form-label small text-muted mb-1">Serviço</label>
          <select
            formControlName="functionalityId"
            class="form-select form-select-sm"
          >
            <option value="">Todos</option>
            <option *ngFor="let f of functionalities$ | async" [value]="f.id">
              {{ f.name }}
            </option>
          </select>
        </div>

        <div class="col-6 col-md-3 col-lg-2">
          <label class="form-label small text-muted mb-1">Responsável</label>
          <select
            formControlName="responsibleId"
            class="form-select form-select-sm"
          >
            <option value="">Todos</option>
            <option *ngFor="let u of users$ | async" [value]="u.id">
              {{ u.name }}
            </option>
          </select>
        </div>

        <div class="col-6 col-md-3 col-lg-2">
          <label class="form-label small text-muted mb-1">Status Trab.</label>
          <select
            formControlName="workStatus"
            class="form-select form-select-sm"
          >
            <option value="">Todos</option>
            <option value="PENDING">Pendente</option>
            <option value="IN_PROGRESS">Em Andamento</option>
            <option value="OVERDUE">Atrasado</option>
            <option value="FINISHED">Finalizado</option>
          </select>
        </div>

        <div class="col-12 col-md-auto ms-auto d-flex gap-2">
          <button
            class="btn btn-sm btn-light border"
            (click)="clearFilters()"
            title="Limpar Filtros"
          >
            <i class="bi bi-eraser"></i>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div *ngIf="isLoading$ | async" class="text-center py-5">
    <div
      class="spinner-border text-brand spinner-border-sm"
      role="status"
    ></div>
    <div class="small text-muted mt-2">Carregando dados...</div>
  </div>

  <div
    class="card border-0 shadow-sm"
    *ngIf="!(isLoading$ | async) && viewMode === 'MANAGERIAL'"
  >
    <div class="table-responsive">
      <table
        class="table table-hover table-sm align-middle mb-0"
        style="font-size: 0.9rem"
      >
        <thead class="table-light">
          <tr>
            <th class="ps-3">#ID</th>
            <th>Cliente</th>
            <th>Data</th>
            <th>Serviços Principais</th>
            <th>Status Pgto.</th>
            <th>Status Geral</th>
            <th class="text-end pe-3">Valor Total</th>
            <th style="width: 50px"></th>
            <th style="width: 40px"></th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let order of orders$ | async"
            (click)="viewDetails(order.id)"
            style="cursor: pointer"
          >
            <td class="ps-3 fw-bold text-brand">{{ order.orderNumber }}</td>
            <td class="fw-semibold">{{ getClientName(order.client.id) }}</td>
            <td class="text-muted">
              {{ order.contractDate | date : "dd/MM/yy" }}
            </td>
            <td>
              <div class="d-flex align-items-center">
                <span class="text-truncate" style="max-width: 150px">
                  {{ getFunctionalityName(order.items[0].functionality.id) }}
                </span>
                <span
                  *ngIf="order.items.length > 1"
                  class="badge bg-secondary ms-2"
                  style="font-size: 0.7em"
                >
                  +{{ order.items.length - 1 }}
                </span>
              </div>
            </td>
            <td>
              <span
                class="badge border"
                [ngClass]="getStatusBadgeClass(getComputedPaymentStatus(order))"
              >
                {{ getStatusLabel(getComputedPaymentStatus(order)) }}
              </span>
            </td>
            <td>
              <span
                class="badge border"
                [ngClass]="getStatusBadgeClass(getComputedWorkStatus(order))"
              >
                {{ getStatusLabel(getComputedWorkStatus(order)) }}
              </span>
            </td>
            <td class="text-end pe-3 font-monospace">
              {{ order.amountTotal | currency : "BRL" }}
            </td>
            <td class="text-end">
              <i class="bi bi-chevron-right text-muted small"></i>
            </td>
            <td class="text-center">
              <i
                *ngIf="order.observation || order.note"
                class="bi bi-info-circle text-muted"
                style="cursor: help"
                [title]="
                  (order.observation
                    ? 'Observação: ' + order.observation + ' | '
                    : '') + (order.note ? 'Nota: ' + order.note : '')
                "
              ></i>
            </td>
          </tr>
          <tr *ngIf="(orders$ | async)?.length === 0">
            <td colspan="9" class="text-center py-4 text-muted">
              Nenhuma ordem encontrada.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div
    class="card border-0 shadow-sm"
    *ngIf="!(isLoading$ | async) && viewMode === 'OPERATIONAL'"
  >
    <div class="card-header bg-white border-bottom-0 pt-3">
      <h6 class="text-muted small m-0">
        <i class="bi bi-info-circle me-1"></i> Lista detalhada item a item
        (ordenado por prazo)
      </h6>
    </div>
    <div class="table-responsive">
      <table
        class="table table-hover table-sm align-middle mb-0"
        style="font-size: 0.85rem"
      >
        <thead class="table-light">
          <tr>
            <th class="ps-3">Prazo</th>
            <th>Serviço</th>
            <th>Ordem / Cliente</th>
            <th>Responsável</th>
            <th>Status</th>
            <th class="text-end pe-3">Ação</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of serviceRows$ | async">
            <td class="ps-3">
              <div class="d-flex flex-column">
                <span
                  class="fw-bold"
                  [class.text-danger]="row.status === 'OVERDUE'"
                >
                  {{ row.deadline | date : "dd/MM/yy" }}
                </span>
              </div>
            </td>
            <td>
              <span class="fw-semibold text-dark">{{ row.itemName }}</span>
            </td>
            <td>
              <div class="d-flex flex-column">
                <span class="text-brand small fw-bold"
                  >#{{ row.orderNumber }}</span
                >
                <span class="text-muted small">{{ row.clientName }}</span>
              </div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div
                  class="avatar-circle me-2 small fw-bold text-white"
                  [style.background-color]="getAvatarColor(row.responsibleName)"
                  style="
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  "
                >
                  {{ row.responsibleName.charAt(0) }}
                </div>
                {{ row.responsibleName }}
              </div>
            </td>
            <td>
              <span
                class="badge border"
                [ngClass]="getStatusBadgeClass(row.status)"
              >
                {{ getStatusLabel(row.status) }}
              </span>
            </td>
            <td class="text-end pe-3">
              <button
                class="btn btn-sm btn-outline-secondary py-0"
                (click)="viewDetails(row.orderId)"
              >
                Ver <i class="bi bi-arrow-right-short"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="(serviceRows$ | async)?.length === 0">
            <td colspan="6" class="text-center py-4 text-muted">
              Nenhum serviço encontrado.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <div class="small text-muted">Total: {{ totalOrders }} ordens</div>
    <div class="btn-group">
      <button
        class="btn btn-sm btn-outline-secondary"
        [disabled]="currentPage === 0"
        (click)="handlePageEvent(currentPage - 1)"
      >
        Anterior
      </button>
      <button class="btn btn-sm btn-outline-secondary" disabled>
        Página {{ currentPage + 1 }}
      </button>
      <button
        class="btn btn-sm btn-outline-secondary"
        [disabled]="(currentPage + 1) * pageSize >= totalOrders"
        (click)="handlePageEvent(currentPage + 1)"
      >
        Próxima
      </button>
    </div>
  </div>
</div>
