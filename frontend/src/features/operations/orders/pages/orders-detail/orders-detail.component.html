<div
  class="container-fluid p-2 p-md-3 dashboard-container"
  *ngIf="order; else loadingTpl"
>
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-3">
      <a
        routerLink="/orders"
        class="btn btn-outline-secondary btn-sm rounded-circle btn-icon shadow-sm"
      >
        <i class="bi bi-arrow-left"></i>
      </a>
      <div>
        <div class="d-flex align-items-center gap-2">
          <h5 class="mb-0 fw-bold text-primary">
            Ordem #{{ order.orderNumber }}
          </h5>
          <span class="badge bg-light text-secondary border">{{
            order.contractDate | date : "yyyy"
          }}</span>
        </div>
        <div class="text-muted small">
          <i class="bi bi-calendar-event me-1"></i
          >{{ order.contractDate | date : "dd/MM/yyyy" }} •
          <i class="bi bi-building me-1 ms-2"></i
          ><strong>{{ order.client.name }}</strong>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-2 mb-3">
    <div class="col-12 col-md-4">
      <div
        class="card border-0 shadow-sm p-2 h-100 border-start border-3 border-primary bg-white"
      >
        <div class="d-flex justify-content-between">
          <div>
            <div class="text-muted x-small text-uppercase fw-bold mb-1">
              Valor Total (Cliente)
            </div>
            <div class="fs-5 fw-bold text-dark">
              {{ formatMoney(order.amountTotal) }}
            </div>
          </div>
          <i class="bi bi-currency-dollar fs-3 text-primary opacity-25"></i>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div
        class="card border-0 shadow-sm p-2 h-100 border-start border-3 border-danger bg-white"
      >
        <div class="d-flex justify-content-between">
          <div>
            <div class="text-muted x-small text-uppercase fw-bold mb-1">
              Custo Total (Revisores)
            </div>
            <div class="fs-5 fw-bold text-danger">
              {{ formatMoney(totalCost) }}
            </div>
          </div>
          <i class="bi bi-people fs-3 text-danger opacity-25"></i>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div
        class="card border-0 shadow-sm p-2 h-100 border-start border-3 border-success bg-success-subtle"
      >
        <div class="d-flex justify-content-between">
          <div>
            <div class="text-success x-small text-uppercase fw-bold mb-1">
              Lucro Líquido (Real)
            </div>
            <div class="fs-5 fw-bold text-success">
              {{ formatMoney(netProfit) }}
            </div>
            <div class="x-small text-success fw-bold mt-1">
              Margem: {{ profitMargin | number : "1.0-1" }}%
            </div>
          </div>
          <i class="bi bi-graph-up-arrow fs-3 text-success opacity-50"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-xl-8">
      <div class="card border-0 shadow-sm h-100 card-overflow-visible">
        <div
          class="card-header bg-white border-bottom py-2 d-flex justify-content-between align-items-center"
        >
          <h6 class="card-title fw-bold m-0 text-primary">
            <i class="bi bi-list-check me-2"></i>Detalhamento dos Serviços
          </h6>
          <span class="badge bg-light text-dark border"
            >{{ order.items.length }} itens</span
          >
        </div>
        <div class="table-responsive table-overflow-visible">
          <table
            class="table table-hover align-middle mb-0 custom-table"
            style="font-size: 0.9rem"
          >
            <thead class="bg-light">
              <tr>
                <th class="ps-3">Serviço</th>
                <th>Responsável</th>
                <th>Financeiro (Item)</th>
                <th>Prazo</th>
                <th>Status</th>
                <th class="text-end pe-3" style="min-width: 100px">Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of order.items">
                <td class="ps-3 fw-medium">{{ item.functionality.name }}</td>
                <td>
                  <div
                    class="d-flex align-items-center"
                    *ngIf="item.responsible; else noResp"
                  >
                    <div
                      class="avatar-xs bg-primary-subtle text-primary rounded-circle me-2 fw-bold d-flex align-items-center justify-content-center border border-primary-subtle"
                    >
                      {{ item.responsible.name?.charAt(0) || "U" }}
                    </div>
                    <span class="small">{{ item.responsible.name }}</span>
                  </div>
                  <ng-template #noResp
                    ><span class="text-muted small fst-italic"
                      >--</span
                    ></ng-template
                  >
                </td>
                <td>
                  <div
                    class="d-flex flex-column small fw-medium"
                    style="line-height: 1.2"
                  >
                    <span class="text-success"
                      ><i class="bi bi-arrow-up-short me-1"></i
                      >{{ formatMoney(item.price) }}</span
                    >
                    <span class="text-danger"
                      ><i class="bi bi-arrow-down-short me-1"></i
                      >{{ formatMoney(item.responsible?.amount || 0) }}</span
                    >
                  </div>
                </td>
                <td>
                  <span
                    class="small fw-medium"
                    [class.text-danger]="
                      item.itemStatus !== 'FINISHED' &&
                      isOverdue(item.clientDeadline)
                    "
                  >
                    <i class="bi bi-calendar-event me-1 text-muted"></i
                    >{{ item.clientDeadline | date : "dd/MM" }}
                  </span>
                </td>
                <td>
                  <span
                    class="badge rounded-pill fw-normal border px-2"
                    [ngClass]="getStatusBadgeClass(item.itemStatus)"
                  >
                    {{ item.itemStatus }}
                  </span>
                </td>

                <td class="text-end pe-2 position-relative">
                  <div class="dropdown-container d-inline-block">
                    <button
                      class="btn btn-sm btn-light border shadow-sm d-inline-flex align-items-center gap-1 px-2"
                      (click)="toggleDropdown($event, item.id)"
                    >
                      <span
                        *ngIf="loadingItems[item.id]"
                        class="spinner-border spinner-border-sm text-primary me-1"
                      ></span>
                      <span class="small" *ngIf="!loadingItems[item.id]"
                        >Opções</span
                      >
                      <i class="bi bi-chevron-down x-small text-muted"></i>
                    </button>

                    <div
                      class="dropdown-menu dropdown-menu-end shadow-lg border-0"
                      [class.show]="openDropdownId === item.id"
                    >
                      <h6
                        class="dropdown-header bg-light small text-uppercase fw-bold py-1"
                      >
                        Alterar Status
                      </h6>
                      <button
                        class="dropdown-item small"
                        (click)="changeItemStatus(item, 'IN_PROGRESS')"
                      >
                        <i class="bi bi-play-circle text-primary me-2"></i>Em
                        Andamento
                      </button>
                      <button
                        class="dropdown-item small"
                        (click)="changeItemStatus(item, 'AWAITING_CLIENT')"
                      >
                        <i class="bi bi-person-video text-warning me-2"></i
                        >Aguard. Cliente
                      </button>
                      <button
                        class="dropdown-item small"
                        (click)="changeItemStatus(item, 'AWAITING_ADVISOR')"
                      >
                        <i class="bi bi-eyeglasses text-info me-2"></i>Aguard.
                        Revisor
                      </button>
                      <div class="dropdown-divider my-1"></div>
                      <button
                        class="dropdown-item small fw-bold text-success bg-success-subtle"
                        (click)="changeItemStatus(item, 'FINISHED')"
                      >
                        <i class="bi bi-check-lg me-2"></i>Finalizar
                      </button>
                      <button
                        class="dropdown-item small text-danger"
                        (click)="changeItemStatus(item, 'CANCELED')"
                      >
                        <i class="bi bi-x-circle me-2"></i>Cancelar
                      </button>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-4 d-flex flex-column gap-3">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom py-2">
          <h6 class="card-title fw-bold m-0 text-primary">
            <i class="bi bi-info-circle me-2"></i>Informações
          </h6>
        </div>
        <div class="card-body p-2 small">
          <div class="mb-2 p-2 bg-light rounded border border-light-subtle">
            <div class="text-muted x-small text-uppercase fw-bold mb-1">
              Descrição do Trabalho
            </div>
            <div class="text-dark fw-medium">
              {{ order.description || "—" }}
            </div>
          </div>
          <div
            class="p-2 bg-warning-subtle rounded border border-warning-subtle"
          >
            <div class="text-muted x-small text-uppercase fw-bold mb-1">
              Observação Interna
            </div>
            <div class="text-dark-emphasis fw-medium">
              {{ order.observation || "—" }}
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom py-2">
          <h6 class="card-title fw-bold m-0 text-info">
            <i class="bi bi-person-badge me-2"></i>Informações Adicionais do
            Cliente
          </h6>
        </div>
        <div class="card-body p-2 small">
          <div
            class="mb-2 p-2 bg-info-subtle rounded border border-info-subtle"
          >
            <div class="text-muted x-small text-uppercase fw-bold mb-1">
              Descrição
            </div>
            <div class="text-dark fw-medium">
              {{ order.client.description || "—" }}
            </div>
          </div>
          <div class="p-2 bg-light rounded border border-light-subtle">
            <div class="text-muted x-small text-uppercase fw-bold mb-1">
              Observação
            </div>
            <div class="text-dark fw-medium">
              {{ order.client.note || "—" }}
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom py-2">
          <h6 class="card-title fw-bold m-0 text-success">
            <i class="bi bi-wallet2 me-2"></i>Recebimentos
          </h6>
          <div class="d-flex align-items-center mt-2 small gap-2">
            <div class="progress flex-grow-1" style="height: 6px">
              <div
                class="progress-bar bg-success"
                [style.width.%]="(order.amountPaid / order.amountTotal) * 100"
              ></div>
            </div>
            <span class="fw-bold text-success x-small"
              >{{
                (order.amountPaid / order.amountTotal) * 100 | number : "1.0-0"
              }}%</span
            >
          </div>
          <div class="d-flex justify-content-between mt-1 x-small fw-bold">
            <span class="text-muted"
              >Pago:
              <span class="text-success">{{
                formatMoney(order.amountPaid)
              }}</span></span
            >
            <span class="text-muted"
              >Falta:
              <span class="text-danger">{{
                formatMoney(order.amountTotal - order.amountPaid)
              }}</span></span
            >
          </div>
        </div>

        <div class="table-responsive">
          <table
            class="table table-sm align-middle mb-0 table-striped"
            style="font-size: 0.85rem"
          >
            <thead class="bg-light">
              <tr>
                <th class="ps-3">Venc.</th>
                <th>Valor</th>
                <th class="text-end pe-2">Baixa</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let inst of order.installments">
                <td
                  class="ps-3"
                  [class.text-decoration-line-through]="inst.paidAt"
                  [class.text-muted]="inst.paidAt"
                >
                  {{ inst.dueDate | date : "dd/MM" }}
                </td>
                <td class="fw-semibold" [class.text-muted]="inst.paidAt">
                  {{ formatMoney(inst.amount) }}
                </td>
                <td class="text-end pe-2">
                  <ng-container *ngIf="inst.paidAt; else payButton">
                    <span class="badge bg-success text-white border-0 x-small">
                      <i class="bi bi-check me-1"></i
                      >{{ inst.paidAt | date : "dd/MM" }}
                    </span>
                  </ng-container>
                  <ng-template #payButton>
                    <button
                      class="btn btn-success btn-xs shadow-sm text-nowrap"
                      (click)="payInstallment(inst)"
                      [disabled]="loadingItems[inst.id]"
                    >
                      <i
                        *ngIf="!loadingItems[inst.id]"
                        class="bi bi-cash me-1"
                      ></i>
                      <span
                        *ngIf="loadingItems[inst.id]"
                        class="spinner-border spinner-border-sm"
                        style="width: 0.7rem; height: 0.7rem"
                      ></span>
                      Receber
                    </button>
                  </ng-template>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="d-flex justify-content-center py-5">
    <div class="spinner-border text-primary"></div>
  </div>
</ng-template>
